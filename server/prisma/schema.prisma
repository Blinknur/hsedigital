// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id               String   @id @default(cuid())
  name             String
  ownerId          String
  subscriptionPlan String   @default("free")
  ssoConfig        Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users         User[]
  stations      Station[]
  contractors   Contractor[]
  audits        Audit[]
  forms         FormDefinition[]
  incidents     Incident[]
  workPermits   WorkPermit[]

  @@map("organizations")
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  name               String
  password           String
  role               String    // Admin, Compliance Manager, Station Manager, Contractor
  organizationId     String?
  region             String?
  assignedStationIds String[]  @default([])
  contractorId       String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id])
  audits       Audit[]
  incidents    Incident[]
  workPermits  WorkPermit[]

  @@map("users")
}

model Station {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  brand          String?
  region         String?
  address        String?
  location       Json?
  riskCategory   String   @default("Low")
  auditFrequency String   @default("Annually")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  audits       Audit[]
  incidents    Incident[]
  workPermits  WorkPermit[]

  @@map("stations")
}

model Contractor {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  licenseNumber  String?
  specialization String?
  contactPerson  String?
  email          String?
  status         String   @default("Active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("contractors")
}

model Audit {
  id             String   @id @default(cuid())
  organizationId String
  stationId      String
  auditorId      String
  auditNumber    String   @unique
  scheduledDate  DateTime
  completedDate  DateTime?
  status         String   @default("Scheduled")
  formId         String
  findings       Json     @default("[]")
  overallScore   Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  station      Station      @relation(fields: [stationId], references: [id])
  auditor      User         @relation(fields: [auditorId], references: [id])

  @@map("audits")
}

model FormDefinition {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  frequency      String?
  schema         Json
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])

  @@map("form_definitions")
}

model Incident {
  id             String   @id @default(cuid())
  organizationId String
  stationId      String
  reporterId     String
  incidentType   String
  severity       String
  description    String
  status         String   @default("Open")
  reportedAt     DateTime @default(now())
  resolvedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  station      Station      @relation(fields: [stationId], references: [id])
  reporter     User         @relation(fields: [reporterId], references: [id])

  @@map("incidents")
}

model WorkPermit {
  id             String   @id @default(cuid())
  organizationId String
  stationId      String
  requestedBy    String
  permitType     String
  description    String
  status         String   @default("Pending")
  validFrom      DateTime
  validTo        DateTime
  approvedBy     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  station      Station      @relation(fields: [stationId], references: [id])
  requester    User         @relation(fields: [requestedBy], references: [id])

  @@map("work_permits")
}
