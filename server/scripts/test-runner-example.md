# Regression Test Runner Examples

## Command Examples

### Local Development

```bash
# Run all tests with coverage
npm run test:regression

# Run only fast tests (unit tests, <5s each)
npm run test:regression:fast

# Run critical tests (auth, tenant isolation, billing)
npm run test:regression:critical

# Run unit tests only
npm run test:regression:unit

# Run integration tests only
npm run test:regression:integration

# Watch mode for TDD
npm run test:watch

# Generate coverage report
npm run test:coverage
```

### CI/CD

```bash
# GitHub Actions automatically runs:
# - On PR: critical-tests + fast-tests
# - On push to main: full-regression
# - Nightly: full-regression

# Manual trigger from GitHub UI:
# Actions â†’ Regression Tests â†’ Run workflow
```

### Docker

```bash
# Run tests in Docker container
docker-compose -f docker/docker-compose.yml exec app npm run test:regression:fast

# Run with clean environment
docker-compose -f docker/docker-compose.yml down -v
docker-compose -f docker/docker-compose.yml up -d
docker-compose -f docker/docker-compose.yml exec app npx prisma db push
docker-compose -f docker/docker-compose.yml exec app npm run test:regression:critical
```

## Output Examples

### Successful Test Run

```
ðŸ§ª Running critical regression tests...

Pattern: src/tests/auth.test.js|src/tests/tenant-isolation.test.js|src/tests/stripe.test.js

 PASS  src/tests/auth.test.js
 PASS  src/tests/tenant-isolation.test.js
 PASS  src/tests/stripe.test.js

Test Suites: 3 passed, 3 total
Tests:       42 passed, 42 total
Snapshots:   0 total
Time:        15.234 s

âœ… critical tests completed successfully!

ðŸ“Š Coverage Summary:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Lines      : 78.5% (1245/1586)
Statements : 79.2% (1312/1656)
Functions  : 72.3% (234/324)
Branches   : 68.9% (456/662)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“„ Full HTML report: file:///path/to/server/coverage/index.html
ðŸ“„ Test results: file:///path/to/server/test-results/index.html
```

### Failed Test Run

```
ðŸ§ª Running critical regression tests...

 FAIL  src/tests/auth.test.js
  â— Authentication â€º should validate JWT tokens

    expect(received).toBeTruthy()
    Received: null

      45 |     const token = authService.generateAccessToken(mockUser);
      46 |     const decoded = authService.verifyAccessToken(token);
    > 47 |     expect(decoded).toBeTruthy();
         |                     ^
      48 |   });

Test Suites: 1 failed, 2 passed, 3 total
Tests:       1 failed, 41 passed, 42 total
Snapshots:   0 total
Time:        15.234 s

âŒ critical tests failed!
```

## GitHub Actions Workflow

### PR Comment Example

```markdown
## ðŸ§ª Critical Test Results

| Metric | Coverage |
|--------|----------|
| Lines | 78.5% (1245/1586) |
| Statements | 79.2% (1312/1656) |
| Functions | 72.3% (234/324) |
| Branches | 68.9% (456/662) |

**Tests:** Critical (Auth, Tenant Isolation, Billing)
**Status:** success
```

### Failure Notification Issue

```markdown
## ðŸš¨ Regression Tests Failed - Fix authentication bug

**Workflow:** Regression Tests
**Run ID:** 1234567890
**Branch:** refs/heads/feature/new-auth
**Commit:** abc123def456
**Author:** developer
**Triggered by:** pull_request

### Failed Jobs
- Critical Tests: failure
- Fast Tests: success

[View Full Results](https://github.com/org/repo/actions/runs/1234567890)

### Next Steps
1. Review the test failures in the workflow logs
2. Check the uploaded test results and coverage reports
3. Fix failing tests or update test expectations
4. Re-run the workflow after fixes

---
*This issue was automatically created by the regression test workflow*
```

## Test Summary Report

After running tests, a markdown summary is generated:

```markdown
# Test Summary Report

Generated: 2024-01-15T10:30:00.000Z

## ðŸ“Š Test Results

| Status | Count |
|--------|-------|
| âœ… Passed | 41 |
| âŒ Failed | 1 |
| â­ï¸ Skipped | 0 |
| **Total** | **42** |

## ðŸ“ˆ Code Coverage

| Metric | Coverage | Covered | Total |
|--------|----------|---------|-------|
| Lines | 78.5% | 1245 | 1586 |
| Statements | 79.2% | 1312 | 1656 |
| Functions | 72.3% | 234 | 324 |
| Branches | 68.9% | 456 | 662 |

## ðŸŽ¯ Coverage Status

ðŸŸ¢ **Excellent** - Coverage is above 80%

## ðŸ“ Reports

- [HTML Coverage Report](../coverage/index.html)
- [Detailed Test Results](./index.html)
- [JUnit XML](./junit.xml)

---

*Generated by automated test suite*
```

## Debugging Tests

### Run Single Test File

```bash
cd server
npm test -- src/tests/auth.test.js
```

### Run Single Test Suite

```bash
npm test -- src/tests/auth.test.js -t "Authentication"
```

### Run with Verbose Output

```bash
npm test -- --verbose src/tests/auth.test.js
```

### Debug with Node Inspector

```bash
node --inspect-brk node_modules/.bin/jest --runInBand src/tests/auth.test.js
```

### Clear Jest Cache

```bash
npx jest --clearCache
```

## Viewing Reports

### Coverage Report

```bash
# Generate and open
npm run test:coverage
open coverage/index.html

# Or manually open
open server/coverage/index.html
```

### Test Results

```bash
# Open HTML test report
open server/test-results/index.html
```

### Download CI Artifacts

1. Go to Actions tab in GitHub
2. Click on workflow run
3. Scroll to "Artifacts" section
4. Download:
   - `critical-coverage-report.zip`
   - `critical-test-results.zip`
   - `fast-coverage-report.zip`
   - `fast-test-results.zip`

## Custom Test Execution

### Run Specific Pattern

```bash
# Run all auth-related tests
npm test -- --testPathPattern=auth

# Run all integration tests
npm test -- --testPathPattern=integration
```

### Run Tests Matching Name

```bash
# Run tests with "tenant" in the name
npm test -- -t "tenant"

# Run tests with "isolation" in the name
npm test -- -t "isolation"
```

### Update Snapshots

```bash
npm test -- --updateSnapshot
```

### Collect Coverage for Specific Files

```bash
npm test -- --collectCoverageFrom="src/services/authService.js"
```

## Best Practices

1. **Always run critical tests before pushing**: `npm run test:regression:critical`
2. **Use fast tests during development**: `npm run test:regression:fast`
3. **Review coverage reports**: Aim for >60% coverage
4. **Check test results in CI**: Don't merge failing PRs
5. **Update test tags**: Keep `.test-tags.json` current
6. **Write descriptive test names**: Make failures easy to understand
7. **Clean up test data**: Always cleanup in afterEach/afterAll
8. **Mock external services**: Don't rely on external APIs in tests

## Troubleshooting

### Tests Pass Locally but Fail in CI

Check environment differences:
- Database version
- Node version
- Environment variables
- Timezone settings
- File permissions

### Flaky Tests

Identify and fix:
```bash
# Run test multiple times
for i in {1..10}; do npm test -- src/tests/flaky.test.js; done

# Increase timeout
# In test file:
jest.setTimeout(30000);
```

### Out of Memory

Increase Node memory:
```bash
NODE_OPTIONS="--max-old-space-size=4096" npm test
```

### Database Connection Issues

Verify connection:
```bash
# Check DATABASE_URL
echo $DATABASE_URL

# Test connection
psql $DATABASE_URL -c "SELECT 1"

# Check if Prisma client is generated
npx prisma generate
```
