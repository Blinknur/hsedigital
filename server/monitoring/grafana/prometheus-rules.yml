groups:
  - name: hse_digital_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          (
            rate(hse_digital_http_request_errors_total[5m])
            / rate(hse_digital_http_requests_total[5m])
          ) > 0.05
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes (threshold: 5%)"

      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, 
            rate(hse_digital_http_request_duration_seconds_bucket[5m])
          ) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency detected"
          description: "P95 latency is {{ $value }}s (threshold: 5s)"

      - alert: DatabaseSlowQueries
        expr: |
          histogram_quantile(0.95, 
            rate(hse_digital_database_query_duration_seconds_bucket[5m])
          ) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries detected"
          description: "P95 query time is {{ $value }}s on {{ $labels.model }}.{{ $labels.operation }}"

      - alert: HighDatabaseErrorRate
        expr: |
          rate(hse_digital_database_queries_total{status="error"}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "High database error rate"
          description: "Database error rate is {{ $value }} queries/sec"

      - alert: ServiceDown
        expr: up{job="hse-digital"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "HSE Digital service is down"
          description: "The HSE Digital service has been down for more than 1 minute"

      - alert: HighMemoryUsage
        expr: |
          process_resident_memory_bytes{job="hse-digital"} 
          / 1024 / 1024 / 1024 > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value }}GB (threshold: 1GB)"

      - alert: HighAuthFailureRate
        expr: |
          rate(hse_digital_auth_failures_total[5m]) > 0.5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High authentication failure rate"
          description: "Auth failure rate is {{ $value }} failures/sec - possible attack"

      - alert: HighRateLimitHits
        expr: |
          rate(hse_digital_rate_limit_hits_total[5m]) > 1
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "High rate limit hits"
          description: "Rate limit hit {{ $value }} times/sec for {{ $labels.limit_type }}"

      - alert: LowCacheHitRate
        expr: |
          (
            rate(hse_digital_cache_hits_total[5m])
            / (rate(hse_digital_cache_hits_total[5m]) + rate(hse_digital_cache_misses_total[5m]))
          ) < 0.5
        for: 10m
        labels:
          severity: info
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} (threshold: 50%)"

      - alert: TenantHighErrorRate
        expr: |
          rate(hse_digital_tenant_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate for tenant"
          description: "Tenant {{ $labels.tenant_id }} has error rate of {{ $value }} errors/sec"

      - alert: TenantHighLatency
        expr: |
          histogram_quantile(0.95,
            rate(hse_digital_tenant_latency_seconds_bucket[5m])
          ) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High latency for tenant"
          description: "Tenant {{ $labels.tenant_id }} P95 latency is {{ $value }}s on {{ $labels.endpoint }}"
